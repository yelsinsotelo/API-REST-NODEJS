"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _Equipment = _interopRequireDefault(require("../models/migrations/Equipment"));

var _qrWithLogo = _interopRequireDefault(require("qr-with-logo"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _constants = require("../config/constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var BASEDIR = _path["default"].join(__dirname, '../images/');

var BASEDIR3 = _path["default"].join(__dirname, '../images/team/');

var BASEDIR2 = _path["default"].join(__dirname, '../images/QrCode/');

var AlarmaController = /*#__PURE__*/function () {
  function AlarmaController() {
    _classCallCheck(this, AlarmaController);
  }

  _createClass(AlarmaController, null, [{
    key: "Index",
    value: function Index(req, res) {
      _Equipment["default"].find().exec().then(function (result) {
        res.status(200).json({
          success: true,
          data: {
            alarmas: result,
            numAlarms: result.length
          }
        });
      })["catch"](function (e) {
        res.status(500).json({
          success: false,
          data: {
            error: e
          }
        });
      });
    }
  }, {
    key: "Store",
    value: function Store(req, res) {
      var _req$body = req.body,
          equipment_ip = _req$body.equipment_ip,
          equipment_id = _req$body.equipment_id,
          equipment_name = _req$body.equipment_name,
          equipment_num = _req$body.equipment_num;
      var data = JSON.stringify({
        id_MCU: equipment_id
      });
      var path = BASEDIR2 + equipment_id + '.png';

      _fs["default"].unlink(path, function (err) {
        return console.log(err);
      });

      _qrWithLogo["default"].generateQRWithLogo(data, BASEDIR + 'recorteu.png', {}, "PNG", BASEDIR2 + equipment_id + '.png').then(function (result) {
        return console.log("completo");
      })["catch"](function (e) {
        return console.log(e);
      });

      var urlcode = "".concat(_constants.BASEURL, "/QrCode/") + equipment_id + '.png';
      var newAlarma = new _Equipment["default"]({
        ip: equipment_ip,
        id_MCU: equipment_id,
        name: equipment_name,
        numEquipment: equipment_num,
        urlqr: urlcode
      });
      newAlarma.save().then(function (result) {
        _Equipment["default"].find().exec().then(function (result) {
          res.json({
            success: true,
            data: {
              alarmas: result,
              numAlarms: result.length,
              message: "Se registro correctamente la alarma"
            }
          });
        });
      })["catch"](function (e) {
        return res.json({
          success: false,
          error: e
        });
      });
    }
  }, {
    key: "InternalStore",
    value: function InternalStore(req) {
      var ip = req.ip,
          id_MCU = req.id_MCU,
          index = req.index;
      var data = JSON.stringify({
        id_MCU: id_MCU
      });
      var path = BASEDIR2 + id_MCU + '.png';

      _fs["default"].unlink(path, function (err) {
        return console.log(err);
      });

      _qrWithLogo["default"].generateQRWithLogo(data, BASEDIR + 'recorteu.png', {}, "PNG", BASEDIR2 + id_MCU + '.png').then(function (result) {
        return console.log("completo");
      })["catch"](function (e) {
        return console.log(e);
      });

      var urlcode = "".concat(_constants.BASEURL, "/QrCode/") + id_MCU + '.png';
      var newAlarma = new _Equipment["default"]({
        ip: ip,
        id_MCU: id_MCU,
        name: ip,
        numEquipment: index,
        urlqr: urlcode
      });
      newAlarma.save().then(function (result) {
        console.log(result);
      })["catch"](function (e) {
        console.log(e);
      });
    }
  }, {
    key: "Edit",
    value: function Edit(req, res) {
      _Equipment["default"].findById(req.params.id).exec().then(function (result) {
        result.ip = req.body.equipment_ip, result.id_MCU = req.body.equipment_id, result.name = req.body.equipment_name, result.numEquipment = req.body.equipment_num, result.save().then(function (result) {
          res.json({
            success: true,
            data: {
              message: 'success',
              code: result
            }
          });
        })["catch"](function (error) {
          res.json({
            success: false,
            data: {
              message: 'error',
              code: error
            }
          });
        });
      })["catch"](function (error) {
        res.json({
          success: false,
          data: {
            message: 'error',
            code: error
          }
        });
      });
    }
  }, {
    key: "Update",
    value: function Update(req, res) {
      var solicitud = JSON.parse(JSON.stringify(req.body));

      _Equipment["default"].findOne({
        id_MCU: solicitud.id_MCU
      }).exec().then(function (result) {
        result.name = solicitud.name;
        result.latCenter = solicitud.latitude;
        result.lngCenter = solicitud.longitude;
        result.state = "conectado";
        result.save();
        console.log(result);
        res.status(200).json({
          success: true,
          data: "completo"
        });
      })["catch"](function (error) {
        console.log(error);
        res.status(500).json({
          success: false,
          data: error
        });
      });
    }
  }, {
    key: "Destroy",
    value: function Destroy(req, res) {
      _Equipment["default"].findByIdAndDelete(req.params.id).exec().then(function (result) {
        res.json({
          success: true,
          data: {
            message: 'success',
            code: result
          }
        });
      })["catch"](function (error) {
        res.json({
          success: false,
          data: {
            message: 'error',
            code: error
          }
        });
      });
    }
  }]);

  return AlarmaController;
}();

var _default = AlarmaController;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9BbGFybWFDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkJBU0VESVIiLCJwYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsIkJBU0VESVIzIiwiQkFTRURJUjIiLCJBbGFybWFDb250cm9sbGVyIiwicmVxIiwicmVzIiwiRXF1aXBtZW50IiwiZmluZCIsImV4ZWMiLCJ0aGVuIiwicmVzdWx0Iiwic3RhdHVzIiwianNvbiIsInN1Y2Nlc3MiLCJkYXRhIiwiYWxhcm1hcyIsIm51bUFsYXJtcyIsImxlbmd0aCIsImUiLCJlcnJvciIsImJvZHkiLCJlcXVpcG1lbnRfaXAiLCJlcXVpcG1lbnRfaWQiLCJlcXVpcG1lbnRfbmFtZSIsImVxdWlwbWVudF9udW0iLCJKU09OIiwic3RyaW5naWZ5IiwiaWRfTUNVIiwiZnMiLCJ1bmxpbmsiLCJlcnIiLCJjb25zb2xlIiwibG9nIiwiUVJsb2dvIiwiZ2VuZXJhdGVRUldpdGhMb2dvIiwidXJsY29kZSIsIkJBU0VVUkwiLCJuZXdBbGFybWEiLCJpcCIsIm5hbWUiLCJudW1FcXVpcG1lbnQiLCJ1cmxxciIsInNhdmUiLCJtZXNzYWdlIiwiaW5kZXgiLCJmaW5kQnlJZCIsInBhcmFtcyIsImlkIiwiY29kZSIsInNvbGljaXR1ZCIsInBhcnNlIiwiZmluZE9uZSIsImxhdENlbnRlciIsImxhdGl0dWRlIiwibG5nQ2VudGVyIiwibG9uZ2l0dWRlIiwic3RhdGUiLCJmaW5kQnlJZEFuZERlbGV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBQ0EsSUFBTUEsT0FBTyxHQUFHQyxpQkFBS0MsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLFlBQXJCLENBQWhCOztBQUNBLElBQU1DLFFBQVEsR0FBR0gsaUJBQUtDLElBQUwsQ0FBVUMsU0FBVixFQUFxQixpQkFBckIsQ0FBakI7O0FBQ0EsSUFBTUUsUUFBUSxHQUFHSixpQkFBS0MsSUFBTCxD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Jy4uL21vZGVscy9taWdyYXRpb25zL0VxdWlwbWVudCc7XHJcbmltcG9ydCBRUmxvZ28gZnJvbSAncXItd2l0aC1sb2dvJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCB7QkFTRVVSTH0gZnJvbSAnLi4vY29uZmlnL2NvbnN0YW50cydcclxuY29uc3QgQkFTRURJUiA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9pbWFnZXMvJyk7XHJcbmNvbnN0IEJBU0VESVIzID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2ltYWdlcy90ZWFtLycpO1xyXG5jb25zdCBCQVNFRElSMiA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9pbWFnZXMvUXJDb2RlLycpO1xyXG5cclxuY2xhc3MgQWxhcm1hQ29udHJvbGxlciB7XHJcbiAgICBzdGF0aWMgSW5kZXgocmVxLCByZXMpIHtcclxuICAgICAgICBFcXVpcG1lbnQuZmluZCgpLmV4ZWMoKVxyXG4gICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGFybWFzOiByZXN1bHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bUFsYXJtczogcmVzdWx0Lmxlbmd0aCxcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZSxcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICApXHJcbiAgICB9XHJcbiAgICBzdGF0aWMgU3RvcmUocmVxLCByZXMpIHtcclxuICAgICAgICBjb25zdCB7IGVxdWlwbWVudF9pcCwgZXF1aXBtZW50X2lkLCBlcXVpcG1lbnRfbmFtZSwgZXF1aXBtZW50X251bSB9ID0gcmVxLmJvZHk7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgaWRfTUNVOiBlcXVpcG1lbnRfaWQsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IEJBU0VESVIyICsgZXF1aXBtZW50X2lkICsgJy5wbmcnO1xyXG4gICAgICAgIGZzLnVubGluayhwYXRoLChlcnIpID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gICAgICAgIFFSbG9nby5nZW5lcmF0ZVFSV2l0aExvZ28oZGF0YSwgQkFTRURJUiArICdyZWNvcnRldS5wbmcnLCB7fSwgXCJQTkdcIiwgQkFTRURJUjIgKyBlcXVpcG1lbnRfaWQgKyAnLnBuZycpLnRoZW4ocmVzdWx0ID0+XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY29tcGxldG9cIikpLmNhdGNoKGUgPT4gY29uc29sZS5sb2coZSkpO1xyXG4gICAgICAgIGNvbnN0IHVybGNvZGUgPSBgJHtCQVNFVVJMfS9RckNvZGUvYCArIGVxdWlwbWVudF9pZCArICcucG5nJztcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBuZXdBbGFybWEgPSBuZXcgRXF1aXBtZW50KHtcclxuICAgICAgICAgICAgaXA6IGVxdWlwbWVudF9pcCxcclxuICAgICAgICAgICAgaWRfTUNVOiBlcXVpcG1lbnRfaWQsXHJcbiAgICAgICAgICAgIG5hbWU6IGVxdWlwbWVudF9uYW1lLFxyXG4gICAgICAgICAgICBudW1FcXVpcG1lbnQ6IGVxdWlwbWVudF9udW0sXHJcbiAgICAgICAgICAgIHVybHFyOiB1cmxjb2RlLFxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgbmV3QWxhcm1hLnNhdmUoKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIEVxdWlwbWVudC5maW5kKCkuZXhlYygpXHJcbiAgICAgICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxhcm1hczogcmVzdWx0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtQWxhcm1zOiByZXN1bHQubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogXCJTZSByZWdpc3RybyBjb3JyZWN0YW1lbnRlIGxhIGFsYXJtYVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIClcclxuICAgICAgICAgICAgLmNhdGNoKGUgPT4gKFxyXG4gICAgICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBlLFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgSW50ZXJuYWxTdG9yZShyZXEpIHtcclxuICAgICAgICBjb25zdCB7IGlwLCBpZF9NQ1UsIGluZGV4IH0gPSByZXE7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgaWRfTUNVOiBpZF9NQ1UsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IEJBU0VESVIyICsgaWRfTUNVICsgJy5wbmcnO1xyXG4gICAgICAgIGZzLnVubGluayhwYXRoLChlcnIpID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gICAgICAgIFFSbG9nby5nZW5lcmF0ZVFSV2l0aExvZ28oZGF0YSwgQkFTRURJUiArICdyZWNvcnRldS5wbmcnLCB7fSwgXCJQTkdcIiwgQkFTRURJUjIgKyBpZF9NQ1UgKyAnLnBuZycpLnRoZW4ocmVzdWx0ID0+XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY29tcGxldG9cIikpLmNhdGNoKGUgPT4gY29uc29sZS5sb2coZSkpO1xyXG4gICAgICAgIGNvbnN0IHVybGNvZGUgPSBgJHtCQVNFVVJMfS9RckNvZGUvYCArIGlkX01DVSArICcucG5nJztcclxuICAgICAgICBjb25zdCBuZXdBbGFybWEgPSBuZXcgRXF1aXBtZW50KHtcclxuICAgICAgICAgICAgaXA6IGlwLFxyXG4gICAgICAgICAgICBpZF9NQ1U6IGlkX01DVSxcclxuICAgICAgICAgICAgbmFtZTogaXAsXHJcbiAgICAgICAgICAgIG51bUVxdWlwbWVudDogaW5kZXgsXHJcbiAgICAgICAgICAgIHVybHFyOiB1cmxjb2RlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG5ld0FsYXJtYS5zYXZlKCkudGhlbihyZXN1bHQgPT4geyBjb25zb2xlLmxvZyhyZXN1bHQpfSkuY2F0Y2goZSA9PiB7Y29uc29sZS5sb2coZSl9KTtcclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBFZGl0KHJlcSwgcmVzKSB7XHJcbiAgICAgICAgRXF1aXBtZW50LmZpbmRCeUlkKHJlcS5wYXJhbXMuaWQpLmV4ZWMoKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5pcCA9IHJlcS5ib2R5LmVxdWlwbWVudF9pcCxcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5pZF9NQ1UgPSByZXEuYm9keS5lcXVpcG1lbnRfaWQsXHJcbiAgICAgICAgICAgICAgICByZXN1bHQubmFtZSA9IHJlcS5ib2R5LmVxdWlwbWVudF9uYW1lLFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0Lm51bUVxdWlwbWVudCA9IHJlcS5ib2R5LmVxdWlwbWVudF9udW0sXHJcbiAgICAgICAgICAgICAgICByZXN1bHQuc2F2ZSgpLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXMuanNvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6J3N1Y2Nlc3MnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogcmVzdWx0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6J2Vycm9yJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTonZXJyb3InLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfVxyXG4gICAgc3RhdGljIFVwZGF0ZShyZXEsIHJlcykge1xyXG4gICAgICAgIGNvbnN0IHNvbGljaXR1ZCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmVxLmJvZHkpKTtcclxuICAgICAgICBFcXVpcG1lbnQuZmluZE9uZSh7IGlkX01DVTogc29saWNpdHVkLmlkX01DVSB9KS5leGVjKCkudGhlbihcclxuICAgICAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lID0gc29saWNpdHVkLm5hbWU7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQubGF0Q2VudGVyID0gc29saWNpdHVkLmxhdGl0dWRlO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LmxuZ0NlbnRlciA9IHNvbGljaXR1ZC5sb25naXR1ZGU7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQuc3RhdGUgPSBcImNvbmVjdGFkb1wiO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnNhdmUoKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdClcclxuICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IFwiY29tcGxldG9cIixcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApLmNhdGNoKFxyXG4gICAgICAgICAgICBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XHJcbiAgICAgICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogZXJyb3JcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIERlc3Ryb3kocmVxLCByZXMpIHtcclxuICAgICAgICBFcXVpcG1lbnQuZmluZEJ5SWRBbmREZWxldGUocmVxLnBhcmFtcy5pZCkuZXhlYygpLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlIDogJ3N1Y2Nlc3MnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IHJlc3VsdFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA6ICdlcnJvcicsXHJcbiAgICAgICAgICAgICAgICAgICAgY29kZTogZXJyb3JcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgQWxhcm1hQ29udHJvbGxlcjtcclxuIl19