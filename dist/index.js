"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _App = _interopRequireDefault(require("./App"));

require("./config/database");

var _AppMqtt = _interopRequireDefault(require("./AppMqtt"));

var _base64url = _interopRequireDefault(require("base64url"));

var _ip = _interopRequireDefault(require("ip"));

var _http = _interopRequireDefault(require("http"));

var _socket = _interopRequireDefault(require("socket.io"));

var _Users = _interopRequireDefault(require("./models/migrations/Users"));

var _Equipment = _interopRequireDefault(require("./models/migrations/Equipment"));

var _Emergency = _interopRequireDefault(require("./models/migrations/Emergency"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var server = _App["default"].listen(4080);

var io = (0, _socket["default"])(server);
console.log("Server lisen port ", 4080);

_AppMqtt["default"].on('connect', function () {
  console.log("Comunicaci√≥n Mqtt Establecida Correctamente");
});

_AppMqtt["default"].subscribe('Panel/#');

io.on("connection", function (socket) {
  _AppMqtt["default"].on('message', function (topic, message) {
    console.log(message.toString());
    var url = topic.toString();
    var id = url.substring(6, 22);
    var opcode = url.substring(23, url.length);
    console.log(opcode);
    console.log(id);
    var data = [];
    var response = [];

    switch (opcode) {
      case "STATUS":
        data = JSON.parse(message);
        data.ip = _ip["default"].toString(_base64url["default"].toBuffer(data.ip));
        console.log(data);
        response = _Users["default"].findOne({
          idEquipment: id
        }).exec().then(function (result) {
          if (result != null) {
            socket.emit("FromAPI", result);
          }
        })["catch"](function (error) {
          var responsex = {
            success: false,
            action: error
          };
          socket.emit("FromAPI", responsex);
        });
        break;

      case "AUDIO":
        //response = message.toString();
        break;

      case "BUTTON":
        data = JSON.parse(message);
        response = _Users["default"].findOne({
          idEquipment: id
        }).exec().then(function (result) {
          var responsex = [];

          if (data.id == result.idControl) {
            _Equipment["default"].findOne({
              id_MCU: id
            }).exec().then(function (result) {
              responsex = {
                success: true,
                emergency: true,
                lat: result.latCenter,
                lng: result.lngCenter
              };

              if (data.bp == 8) {
                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM1"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM3"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM2"), '1');
              } else if (data.bp == 1) {
                socket.emit("FromAPI", responsex);

                _AppMqtt["default"].publish("Panel/".concat(id, "/AUDIO"), '{"fn":"tono2.wav"}');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM3"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM2"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM1"), '1');

                var emergency = new _Emergency["default"]({
                  lat: result.latCenter != null ? result.latCenter.toString() : 'null',
                  lng: result.lngCenter != null ? result.lngCenter.toString() : 'null',
                  from: 'Control RF',
                  state: 'Pendiente'
                });
                emergency.save().then(function (result) {
                  console.log(result);
                })["catch"](function (error) {
                  console.log(error);
                });
              } else if (data.bp == 2) {
                _AppMqtt["default"].publish("Panel/".concat(id, "/AUDIO"), '{"fn":"tono3.wav"}');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM3"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM2"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM1"), '1');
              } else if (data.bp == 4) {
                _AppMqtt["default"].publish("Panel/".concat(id, "/AUDIO"), '{"tmo":0}');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM3"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM2"), '0');

                _AppMqtt["default"].publish("Panel/".concat(id, "/PGM1"), '0');
              }
            })["catch"](function (e) {
              return console.log("erro2");
            });
          } else {
            responsex = {
              success: false,
              emergency: false
            };
          }
        })["catch"](function (error) {
          var responsex = {
            success: false,
            action: error
          };
          return "error";
        })["finally"](function (e) {
          return "saludo";
        });
        break;

      case "CONFIG":
        response = JSON.parse(message.toString());
        break;

      default:
        break;
    }
  });
});
var _default = io;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJzZXJ2ZXIiLCJhcHAiLCJsaXN0ZW4iLCJpbyIsImNvbnNvbGUiLCJsb2ciLCJhcHBtcXR0Iiwib24iLCJzdWJzY3JpYmUiLCJzb2NrZXQiLCJ0b3BpYyIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsInVybCIsImlkIiwic3Vic3RyaW5nIiwib3Bjb2RlIiwibGVuZ3RoIiwiZGF0YSIsInJlc3BvbnNlIiwiSlNPTiIsInBhcnNlIiwiaXAiLCJiYXNlNjR1cmwiLCJ0b0J1ZmZlciIsIlVzZXJzIiwiZmluZE9uZSIsImlkRXF1aXBtZW50IiwiZXhlYyIsInRoZW4iLCJyZXN1bHQiLCJlbWl0IiwiZXJyb3IiLCJyZXNwb25zZXgiLCJzdWNjZXNzIiwiYWN0aW9uIiwiaWRDb250cm9sIiwiRXF1aXBtZW50IiwiaWRfTUNVIiwiZW1lcmdlbmN5IiwibGF0IiwibGF0Q2VudGVyIiwibG5nIiwibG5nQ2VudGVyIiwiYnAiLCJwdWJsaXNoIiwiRW1lcmdlbmN5IiwiZnJvbSIsInN0YXRlIiwic2F2ZSIsImUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBLElBQU1BLE1BQU0sR0FBR0MsZ0JBQUlDLE1BQUosQ0FBVyxJQUFYLENBQWY7O0FBQ0EsSUFBTUMsRUFBRSxHQUFHLHdCQUFTSCxNQUFULENBQVg7QUFFQUksT0FBTyxDQUFDQyxHQUFSLENBQVksb0JBQVosRUFBa0MsSUFBbEM7O0FBRUFDLG9CQUFRQyxFQUFSLENBQVcsU0FBWCxFQUFzQixZQUFZO0FBQzlCSCxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSw2Q0FBWjtBQUNILENBRkQ7O0FBSUFDLG9CQUFRRSxTQUFSLENBQWtCLFNBQWxCOztBQUNBTCxFQUFFLENBQUNJLEVBQUgsQ0FBTSxZQUFOLEVBQW9CLFVBQUNFLE1BQUQsRUFBWTtBQUM1Qkgsc0JBQVFDLEVBQVIsQ0FBVyxTQUFYLEVBQXNCLFVBQVVHLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCO0FBQzVDUCxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWU0sT0FBTyxDQUFDQyxRQUFSLEVBQVo7QUFDQSxRQUFNQyxHQUFHLEdBQUdILEtBQUssQ0FBQ0UsUUFBTixFQUFaO0FBQ0EsUUFBTUUsRUFBRSxHQUFHRCxHQUFHLENBQUNFLFNBQUosQ0FBYyxDQUFkLEVBQWlCLEVBQWpCLENBQVg7QUFDQSxRQUFNQyxNQUFNLEdBQUdILEdBQUcsQ0FBQ0UsU0FBSixDQUFjLEVBQWQsRUFBa0JGLEdBQUcsQ0FBQ0ksTUFBdEIsQ0FBZjtBQUNBYixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWVcsTUFBWjtBQUNBWixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWVMsRUFBWjtBQUNBLFFBQUlJLElBQUksR0FBRyxFQUFYO0FBQ0EsUUFBSUMsUUFBUSxHQUFHLEVBQWY7O0FBQ0EsWUFBUUgsTUFBUjtBQUNJLFdBQUssUUFBTDtBQUNJRSxRQUFBQSxJQUFJLEdBQUdFLElBQUksQ0FBQ0MsS0FBTCxDQUFXVixPQUFYLENBQVA7QUFDQU8sUUFBQUEsSUFBSSxDQUFDSSxFQUFMLEdBQVVBLGVBQUdWLFFBQUgsQ0FBWVcsc0JBQVVDLFFBQVYsQ0FBbUJOLElBQUksQ0FBQ0ksRUFBeEIsQ0FBWixDQUFWO0FBQ0FsQixRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWEsSUFBWjtBQUNBQyxRQUFBQSxRQUFRLEdBQUdNLGtCQUFNQyxPQUFOLENBQWM7QUFBRUMsVUFBQUEsV0FBVyxFQUFFYjtBQUFmLFNBQWQsRUFBbUNjLElBQW5DLEdBQTBDQyxJQUExQyxDQUNQLFVBQUFDLE1BQU0sRUFBSTtBQUNOLGNBQUlBLE1BQU0sSUFBSSxJQUFkLEVBQW9CO0FBQ2hCckIsWUFBQUEsTUFBTSxDQUFDc0IsSUFBUCxDQUFZLFNBQVosRUFBdUJELE1BQXZCO0FBRUg7QUFDSixTQU5NLFdBUVAsVUFBQUUsS0FBSyxFQUFJO0FBQ0wsY0FBTUMsU0FBUyxHQUFHO0FBQ2RDLFlBQUFBLE9BQU8sRUFBRSxLQURLO0FBRWRDLFlBQUFBLE1BQU0sRUFBRUg7QUFGTSxXQUFsQjtBQUlBdkIsVUFBQUEsTUFBTSxDQUFDc0IsSUFBUCxDQUFZLFNBQVosRUFBdUJFLFNBQXZCO0FBQ0gsU0FkTSxDQUFYO0FBZ0JBOztBQUNKLFdBQUssT0FBTDtBQUNJO0FBQ0E7O0FBQ0osV0FBSyxRQUFMO0FBQ0lmLFFBQUFBLElBQUksR0FBR0UsSUFBSSxDQUFDQyxLQUFMLENBQVdWLE9BQVgsQ0FBUDtBQUNBUSxRQUFBQSxRQUFRLEdBQUdNLGtCQUFNQyxPQUFOLENBQWM7QUFBRUMsVUFBQUEsV0FBVyxFQUFFYjtBQUFmLFNBQWQsRUFBbUNjLElBQW5DLEdBQTBDQyxJQUExQyxDQUNQLFVBQUFDLE1BQU0sRUFBSTtBQUNOLGNBQUlHLFNBQVMsR0FBRyxFQUFoQjs7QUFDQSxjQUFJZixJQUFJLENBQUNKLEVBQUwsSUFBV2dCLE1BQU0sQ0FBQ00sU0FBdEIsRUFBaUM7QUFDN0JDLGtDQUFVWCxPQUFWLENBQWtCO0FBQUVZLGNBQUFBLE1BQU0sRUFBRXhCO0FBQVYsYUFBbEIsRUFBa0NjLElBQWxDLEdBQXlDQyxJQUF6QyxDQUNJLFVBQUFDLE1BQU0sRUFBSTtBQUNORyxjQUFBQSxTQUFTLEdBQUc7QUFDUkMsZ0JBQUFBLE9BQU8sRUFBRSxJQUREO0FBRVJLLGdCQUFBQSxTQUFTLEVBQUUsSUFGSDtBQUdSQyxnQkFBQUEsR0FBRyxFQUFFVixNQUFNLENBQUNXLFNBSEo7QUFJUkMsZ0JBQUFBLEdBQUcsRUFBRVosTUFBTSxDQUFDYTtBQUpKLGVBQVo7O0FBT0Esa0JBQUl6QixJQUFJLENBQUMwQixFQUFMLElBQVcsQ0FBZixFQUFrQjtBQUNkdEMsb0NBQVF1QyxPQUFSLGlCQUF5Qi9CLEVBQXpCLFlBQW9DLEdBQXBDOztBQUNBUixvQ0FBUXVDLE9BQVIsaUJBQXlCL0IsRUFBekIsWUFBb0MsR0FBcEM7O0FBQ0FSLG9DQUFRdUMsT0FBUixpQkFBeUIvQixFQUF6QixZQUFvQyxHQUFwQztBQUNILGVBSkQsTUFJTyxJQUFJSSxJQUFJLENBQUMwQixFQUFMLElBQVcsQ0FBZixFQUFrQjtBQUVyQm5DLGdCQUFBQSxNQUFNLENBQUNzQixJQUFQLENBQVksU0FBWixFQUF1QkUsU0FBdkI7O0FBQ0EzQixvQ0FBUXVDLE9BQVIsaUJBQXlCL0IsRUFBekIsYUFBcUMsb0JBQXJDOztBQUNBUixvQ0FBUXVDLE9BQVIsaUJBQXlCL0IsRUFBekIsWUFBb0MsR0FBcEM7O0FBQ0FSLG9DQUFRdUMsT0FBUixpQkFBeUIvQixFQUF6QixZQUFvQyxHQUFwQzs7QUFDQVIsb0NBQVF1QyxPQUFSLGlCQUF5Qi9CLEVBQXpCLFlBQW9DLEdBQXBDOztBQUNBLG9CQUFNeUIsU0FBUyxHQUFHLElBQUlPLHFCQUFKLENBQWM7QUFDNUJOLGtCQUFBQSxHQUFHLEVBQUVWLE1BQU0sQ0FBQ1csU0FBUCxJQUFvQixJQUFwQixHQUEyQlgsTUFBTSxDQUFDVyxTQUFQLENBQWlCN0IsUUFBakIsRUFBM0IsR0FBeUQsTUFEbEM7QUFFNUI4QixrQkFBQUEsR0FBRyxFQUFFWixNQUFNLENBQUNhLFNBQVAsSUFBb0IsSUFBcEIsR0FBMkJiLE1BQU0sQ0FBQ2EsU0FBUCxDQUFpQi9CLFFBQWpCLEVBQTNCLEdBQXlELE1BRmxDO0FBRzVCbUMsa0JBQUFBLElBQUksRUFBRSxZQUhzQjtBQUk1QkMsa0JBQUFBLEtBQUssRUFBRTtBQUpxQixpQkFBZCxDQUFsQjtBQU1BVCxnQkFBQUEsU0FBUyxDQUFDVSxJQUFWLEdBQWlCcEIsSUFBakIsQ0FBc0IsVUFBQUMsTUFBTSxFQUFJO0FBQzVCMUIsa0JBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZeUIsTUFBWjtBQUNILGlCQUZELFdBR1EsVUFBQUUsS0FBSyxFQUFJO0FBQUU1QixrQkFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVkyQixLQUFaO0FBQW9CLGlCQUh2QztBQUlILGVBakJNLE1BaUJBLElBQUlkLElBQUksQ0FBQzBCLEVBQUwsSUFBVyxDQUFmLEVBQWtCO0FBQ3JCdEMsb0NBQVF1QyxPQUFSLGlCQUF5Qi9CLEVBQXpCLGFBQXFDLG9CQUFyQzs7QUFDQVIsb0NBQVF1QyxPQUFSLGlCQUF5Qi9CLEVBQXpCLFlBQW9DLEdBQXBDOztBQUNBUixvQ0FBUXVDLE9BQVIsaUJBQXlCL0IsRUFBekIsWUFBb0MsR0FBcEM7O0FBQ0FSLG9DQUFRdUMsT0FBUixpQkFBeUIvQixFQUF6QixZQUFvQyxHQUFwQztBQUNILGVBTE0sTUFLQSxJQUFJSSxJQUFJLENBQUMwQixFQUFMLElBQVcsQ0FBZixFQUFrQjtBQUNyQnRDLG9DQUFRdUMsT0FBUixpQkFBeUIvQixFQUF6QixhQUFxQyxXQUFyQzs7QUFDQVIsb0NBQVF1QyxPQUFSLGlCQUF5Qi9CLEVBQXpCLFlBQW9DLEdBQXBDOztBQUNBUixvQ0FBUXVDLE9BQVIsaUJBQXlCL0IsRUFBekIsWUFBb0MsR0FBcEM7O0FBQ0FSLG9DQUFRdUMsT0FBUixpQkFBeUIvQixFQUF6QixZQUFvQyxHQUFwQztBQUNIO0FBQ0osYUF6Q0wsV0EyQ0ksVUFBQW9DLENBQUM7QUFBQSxxQkFBSTlDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLE9BQVosQ0FBSjtBQUFBLGFBM0NMO0FBNkNILFdBOUNELE1BOENPO0FBQ0g0QixZQUFBQSxTQUFTLEdBQUc7QUFDUkMsY0FBQUEsT0FBTyxFQUFFLEtBREQ7QUFFUkssY0FBQUEsU0FBUyxFQUFFO0FBRkgsYUFBWjtBQUlIO0FBQ0osU0F2RE0sV0F5RFAsVUFBQVAsS0FBSyxFQUFJO0FBQ0wsY0FBTUMsU0FBUyxHQUFHO0FBQ2RDLFlBQUFBLE9BQU8sRUFBRSxLQURLO0FBRWRDLFlBQUFBLE1BQU0sRUFBRUg7QUFGTSxXQUFsQjtBQUlBLGlCQUFPLE9BQVA7QUFDSCxTQS9ETSxhQWlFUCxVQUFBa0IsQ0FBQyxFQUFJO0FBQUUsaUJBQU8sUUFBUDtBQUFrQixTQWpFbEIsQ0FBWDtBQW1FQTs7QUFDSixXQUFLLFFBQUw7QUFDSS9CLFFBQUFBLFFBQVEsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdWLE9BQU8sQ0FBQ0MsUUFBUixFQUFYLENBQVg7QUFDQTs7QUFDSjtBQUNJO0FBbkdSO0FBd0dILEdBakhEO0FBbUhILENBcEhEO2VBc0hlVCxFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFwcCBmcm9tICcuL0FwcCc7XHJcbmltcG9ydCAnLi9jb25maWcvZGF0YWJhc2UnO1xyXG5pbXBvcnQgYXBwbXF0dCBmcm9tICcuL0FwcE1xdHQnO1xyXG5pbXBvcnQgYmFzZTY0dXJsIGZyb20gJ2Jhc2U2NHVybCc7XHJcbmltcG9ydCBpcCBmcm9tICdpcCc7XHJcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnXHJcbmltcG9ydCBzb2NrZXRJbyBmcm9tICdzb2NrZXQuaW8nO1xyXG5pbXBvcnQgVXNlcnMgZnJvbSAnLi9tb2RlbHMvbWlncmF0aW9ucy9Vc2Vycyc7XHJcbmltcG9ydCBFcXVpcG1lbnQgZnJvbSAnLi9tb2RlbHMvbWlncmF0aW9ucy9FcXVpcG1lbnQnO1xyXG5pbXBvcnQgRW1lcmdlbmN5IGZyb20gJy4vbW9kZWxzL21pZ3JhdGlvbnMvRW1lcmdlbmN5JztcclxuY29uc3Qgc2VydmVyID0gYXBwLmxpc3Rlbig0MDgwKTtcclxuY29uc3QgaW8gPSBzb2NrZXRJbyhzZXJ2ZXIpO1xyXG5cclxuY29uc29sZS5sb2coXCJTZXJ2ZXIgbGlzZW4gcG9ydCBcIiwgNDA4MCk7XHJcblxyXG5hcHBtcXR0Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc29sZS5sb2coXCJDb211bmljYWNpw7NuIE1xdHQgRXN0YWJsZWNpZGEgQ29ycmVjdGFtZW50ZVwiKTtcclxufSlcclxuXHJcbmFwcG1xdHQuc3Vic2NyaWJlKCdQYW5lbC8jJyk7XHJcbmlvLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0KSA9PiB7XHJcbiAgICBhcHBtcXR0Lm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gKHRvcGljLCBtZXNzYWdlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZS50b1N0cmluZygpKVxyXG4gICAgICAgIGNvbnN0IHVybCA9IHRvcGljLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgY29uc3QgaWQgPSB1cmwuc3Vic3RyaW5nKDYsIDIyKTtcclxuICAgICAgICBjb25zdCBvcGNvZGUgPSB1cmwuc3Vic3RyaW5nKDIzLCB1cmwubGVuZ3RoKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhvcGNvZGUpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGlkKTtcclxuICAgICAgICBsZXQgZGF0YSA9IFtdO1xyXG4gICAgICAgIGxldCByZXNwb25zZSA9IFtdO1xyXG4gICAgICAgIHN3aXRjaCAob3Bjb2RlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJTVEFUVVNcIjpcclxuICAgICAgICAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5pcCA9IGlwLnRvU3RyaW5nKGJhc2U2NHVybC50b0J1ZmZlcihkYXRhLmlwKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gVXNlcnMuZmluZE9uZSh7IGlkRXF1aXBtZW50OiBpZCB9KS5leGVjKCkudGhlbihcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiRnJvbUFQSVwiLCByZXN1bHQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICkuY2F0Y2goXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZXggPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogZXJyb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoXCJGcm9tQVBJXCIsIHJlc3BvbnNleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiQVVESU9cIjpcclxuICAgICAgICAgICAgICAgIC8vcmVzcG9uc2UgPSBtZXNzYWdlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIkJVVFRPTlwiOlxyXG4gICAgICAgICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9IFVzZXJzLmZpbmRPbmUoeyBpZEVxdWlwbWVudDogaWQgfSkuZXhlYygpLnRoZW4oXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNleCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5pZCA9PSByZXN1bHQuaWRDb250cm9sKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFcXVpcG1lbnQuZmluZE9uZSh7IGlkX01DVTogaWQgfSkuZXhlYygpLnRoZW4oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2V4ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtZXJnZW5jeTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhdDogcmVzdWx0LmxhdENlbnRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxuZzogcmVzdWx0LmxuZ0NlbnRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuYnAgPT0gOCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9QR00xYCwgJzAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcG1xdHQucHVibGlzaChgUGFuZWwvJHtpZH0vUEdNM2AsICcwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBtcXR0LnB1Ymxpc2goYFBhbmVsLyR7aWR9L1BHTTJgLCAnMScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuYnAgPT0gMSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiRnJvbUFQSVwiLCByZXNwb25zZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9BVURJT2AsICd7XCJmblwiOlwidG9ubzIud2F2XCJ9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBtcXR0LnB1Ymxpc2goYFBhbmVsLyR7aWR9L1BHTTNgLCAnMCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9QR00yYCwgJzAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcG1xdHQucHVibGlzaChgUGFuZWwvJHtpZH0vUEdNMWAsICcxJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbWVyZ2VuY3kgPSBuZXcgRW1lcmdlbmN5KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXQ6IHJlc3VsdC5sYXRDZW50ZXIgIT0gbnVsbCA/IHJlc3VsdC5sYXRDZW50ZXIudG9TdHJpbmcoKSA6ICdudWxsJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsbmc6IHJlc3VsdC5sbmdDZW50ZXIgIT0gbnVsbCA/IHJlc3VsdC5sbmdDZW50ZXIudG9TdHJpbmcoKSA6ICdudWxsJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAnQ29udHJvbCBSRicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6ICdQZW5kaWVudGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtZXJnZW5jeS5zYXZlKCkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuY2F0Y2goZXJyb3IgPT4geyBjb25zb2xlLmxvZyhlcnJvcikgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLmJwID09IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcG1xdHQucHVibGlzaChgUGFuZWwvJHtpZH0vQVVESU9gLCAne1wiZm5cIjpcInRvbm8zLndhdlwifScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9QR00zYCwgJzAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcG1xdHQucHVibGlzaChgUGFuZWwvJHtpZH0vUEdNMmAsICcwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBtcXR0LnB1Ymxpc2goYFBhbmVsLyR7aWR9L1BHTTFgLCAnMScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuYnAgPT0gNCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9BVURJT2AsICd7XCJ0bW9cIjowfScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbXF0dC5wdWJsaXNoKGBQYW5lbC8ke2lkfS9QR00zYCwgJzAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcG1xdHQucHVibGlzaChgUGFuZWwvJHtpZH0vUEdNMmAsICcwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBtcXR0LnB1Ymxpc2goYFBhbmVsLyR7aWR9L1BHTTFgLCAnMCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5jYXRjaChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0+IGNvbnNvbGUubG9nKFwiZXJybzJcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNleCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWVyZ2VuY3k6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKS5jYXRjaChcclxuICAgICAgICAgICAgICAgICAgICBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNleCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBlcnJvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvclwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICkuZmluYWxseShcclxuICAgICAgICAgICAgICAgICAgICBlID0+IHsgcmV0dXJuIFwic2FsdWRvXCI7IH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIkNPTkZJR1wiOlxyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBKU09OLnBhcnNlKG1lc3NhZ2UudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG5cclxuICAgIH0pO1xyXG5cclxufSk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBpbzsiXX0=